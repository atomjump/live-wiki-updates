#!/bin/bash

#Run with:
#eval "$(curl -fsSL -H 'Cache-Control: no-cache' https://git.atomjump.com/live-wiki-updates.git/update)"

#Get latest version of loop-server
sudo git -C /jet/www/default/vendor/atomjump/loop-server pull

#Update the main livewiki
sudo git -C /jet/www/default/livewiki pull

#Update the notifications plugin
sudo git -C /jet/www/default/vendor/atomjump/loop-server/plugins/notifications pull



#Update the npm version for sentiment analysis
curl -sL https://deb.nodesource.com/setup_12.x | sudo bash -
sudo apt-get install -y nodejs
sudo npm --prefix /jet/www/default/vendor/atomjump/loop-server/node install /jet/www/default/vendor/atomjump/loop-server/node



#Add a sentiment analysis crontab - but only do this once.
if test -f ~/sentiment-setup.txt; then
	echo "Sentiment has already been set up.\n";
else
	touch ~/sentiment-setup.txt 
	line="*/1 * * * *     /usr/bin/node /jet/www/default/vendor/atomjump/loop-server/node/sentiment.js"; (sudo crontab -u root -l; echo "$line" ) | sudo crontab -u root -
	echo "Sentiment checker has been added to your crontab.";
fi


while true; do
    read -p "Do you wish to update to the latest version of the languages translations from AtomJump (15 languages) (Enter yes or no)?" yn
    case $yn in
        [Yy]* ) #Get the latest language file with all languages
				sudo mv /jet/www/default/vendor/atomjump/loop-server/config/messages.json /jet/www/default/vendor/atomjump/loop-server/config/messages-old-backup.json;
				sudo wget https://git.atomjump.com/change_language.git/languages/en_bg_ch_cht_de_es_fr_hi_in_it_jp_ko_pu_ru/messages.json -P /jet/www/default/vendor/atomjump/loop-server/config/

				#Get the latest language .js entries
				sudo rm chat-inner.js 
				sudo wget https://git.atomjump.com/change_language.git/languages/en_bg_ch_cht_de_es_fr_hi_in_it_jp_ko_pu_ru/chat-inner.js 

				sudo rm chats.js 
				sudo wget https://git.atomjump.com/change_language.git/languages/en_bg_ch_cht_de_es_fr_hi_in_it_jp_ko_pu_ru/chats.js


				#/jet/www/default/livewiki/js/chat-1.0.9.js

				#Get a php script and run this to replace /jet/www/default/livewiki/js/chat-*.js
				sudo rm update-language.txt
				sudo rm update-language.php
				sudo curl -fsSL -H 'Cache-Control: no-cache' https://git.atomjump.com/live-wiki-updates.git/update-language.txt > update-language.txt
				
				sudo mv update-language.txt update-language.php 
				sudo /jet/bin/php update-language.php
        		break;;
        [Nn]* ) break;;
        * ) echo "Please answer yes or no.";;
    esac
done


